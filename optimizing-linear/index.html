<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta content="width=device-width" name="viewport"><link href="/favicon.svg" rel="icon" type="image/svg+xml"><meta content="Astro v5.12.9" name="generator"><meta content="Uchen - efficient machine learning framework" name="description"><title>Case Study - Optimizing Linear Layer — UchenML</title><meta content="This case study details the process of optimizing linear layer performance without breaking the core Uchen.ML requirements." name="description"><meta content="index,follow" name="robots"><link href="https://uchenml.tech/optimizing-linear" rel="canonical"><meta content="Case Study - Optimizing Linear Layer" property="og:title"><meta content="This case study details the process of optimizing linear layer performance without breaking the core Uchen.ML requirements." property="og:description"><meta content="https://uchenml.tech/optimizing-linear" property="og:url"><meta content="article" property="og:type"><meta content="" property="og:image"><meta content="en" property="og:locale"><meta content="UchenML" property="og:site_name"><meta content="Eugene Ostroukhov" property="og:article:author"><meta content="summary" name="twitter:card"><meta content="@eeuoss" name="twitter:site"><meta content="@eeuoss" name="twitter:creator"><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MVL69VNJN"></script><script>function gtag(...a){dataLayer.push(...a)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-9MVL69VNJN")</script><title>Uchen -</title><link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>:root{--aw-font-sans:"InterVariable";--aw-font-serif:"InterVariable";--aw-font-heading:"InterVariable";--aw-color-primary:rgb(1 97 239);--aw-color-secondary:rgb(1 84 207);--aw-color-accent:rgb(109 40 217);--aw-color-text-heading:"InterVariable";--aw-color-text-default:rgb(16 16 16);--aw-color-text-muted:rgb(16 16 16 / 66%);--aw-color-bg-page:rgb(255 255 255);--aw-color-bg-page-dark:rgb(3 6 32)}.dark{--aw-font-sans:"InterVariable";--aw-font-serif:"InterVariable";--aw-font-heading:"InterVariable";--aw-color-primary:rgb(1 97 239);--aw-color-secondary:rgb(1 84 207);--aw-color-accent:rgb(109 40 217);--aw-color-text-heading:rgb(247, 248, 248);--aw-color-text-default:rgb(229 236 246);--aw-color-text-muted:rgb(229 236 246 / 66%);--aw-color-bg-page:rgb(3 6 32)}.prose pre{overflow-x:auto;white-space:pre;word-wrap:normal}.prose code{white-space:pre-wrap;word-break:break-word}.prose pre code{white-space:pre;word-wrap:normal}html{overflow-x:hidden;max-width:100vw}body{overflow-x:hidden;max-width:100vw}*{max-width:100%;box-sizing:border-box}.prose{max-width:100%;overflow-wrap:break-word;word-wrap:break-word}@media (max-width:640px){.prose{font-size:.875rem;line-height:1.5}}.prose h1,.prose h2,.prose h3,.prose h4,.prose h5,.prose h6,.prose li,.prose p{max-width:100%;overflow-wrap:break-word;word-wrap:break-word}.prose pre{max-width:100%;overflow-x:auto;white-space:pre;word-wrap:normal}.prose code:not(pre code){white-space:pre-wrap;word-break:break-all;max-width:100%}.prose pre::-webkit-scrollbar{height:8px}.prose pre::-webkit-scrollbar-track{background:rgba(156,163,175,.2);border-radius:4px}.prose pre::-webkit-scrollbar-thumb{background:rgba(156,163,175,.5);border-radius:4px;transition:background-color .2s ease}.prose pre::-webkit-scrollbar-thumb:hover{background:rgba(156,163,175,.7)}.dark .prose pre::-webkit-scrollbar-track{background:rgba(75,85,99,.3)}.dark .prose pre::-webkit-scrollbar-thumb{background:rgba(107,114,128,.6)}.dark .prose pre::-webkit-scrollbar-thumb:hover{background:rgba(107,114,128,.8)}.prose pre{scrollbar-width:thin;scrollbar-color:rgba(156,163,175,0.5) rgba(156,163,175,0.2)}.dark .prose pre{scrollbar-color:rgba(107,114,128,0.6) rgba(75,85,99,0.3)}</style><link href="/_astro/_page_.DWpmZqvg.css" rel="stylesheet"><style>@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-cyrillic-ext-wght-normal.B2xhLi22.woff2) format("woff2-variations");unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-cyrillic-wght-normal.CMZtQduZ.woff2) format("woff2-variations");unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-greek-ext-wght-normal.CGAr0uHJ.woff2) format("woff2-variations");unicode-range:U+1F00-1FFF}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-greek-wght-normal.CaVNZxsx.woff2) format("woff2-variations");unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-vietnamese-wght-normal.CBcvBZtf.woff2) format("woff2-variations");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-latin-ext-wght-normal.DO1Apj_S.woff2) format("woff2-variations");unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:Inter Variable;font-style:normal;font-display:swap;font-weight:100 900;src:url(/_astro/inter-latin-wght-normal.Dx4kXJAl.woff2) format("woff2-variations");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}:root{--color-bg:255 255 255;--color-border:255 255 255;--color-box:255 255 255;--box-border:229 231 235;--box-sd:226 232 240/.5;--heading-1:23 37 84;--heading-2:31 41 55;--heading-3:55 65 81}.dark{--color-bg:3 7 18;--color-box:17 24 39;--box-border:243 244 246/.1;--box-sd:transparent;--heading-1:255 255 255;--heading-2:243 244 246;--heading-3:209 213 219}html{scroll-behavior:smooth}body{font-family:Raleway,sans-serif}[data-toggle-nav][data-open-nav=true] #line1{transform:translateY(.375rem) rotate(40deg)}[data-toggle-nav][data-open-nav=true] #line2{transform:scaleX(0);opacity:0}[data-toggle-nav][data-open-nav=true] #line3{transform:translateY(-.375rem) rotate(-40deg)}[data-nav-overlay][data-is-visible=true]{visibility:visible;display:flex}</style></head><body class="bg-amber-50 dark:bg-current overflow-hidden overflow-y-auto"><header class="inset-x-0 absolute py-6 top-0 z-50"><div class="mx-auto lg:px-5 max-w-7xl md:px-14 px-5 sm:px-8 w-full undefined"><nav class="flex justify-between gap-6 relative w-full"><a href="/"><span class="dark:text-white text-gray-900"><svg class="w-36" viewBox="0 0 571.7 180" xmlns="http://www.w3.org/2000/svg" id="Layer_1" style="enable-background:new 0 0 571.7 180" version="1.1" x="0px" xml:space="preserve" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><style>.st0{fill:currentColor}.st1{fill:#0891b2}.st2{fill:#f97316}</style><g id="g16" transform="translate(33.1)"><g id="g9" transform="translate(0,-261.38)"><g id="g8"><path d="m 189.7,318.37 h 7.08 v 53.08 c 0,4.38 -1.4,7.84 -4.2,10.36 -2.8,2.53 -7.09,3.79 -12.89,3.79 -5.8,0 -10.13,-1.26 -12.99,-3.79 -2.87,-2.53 -4.3,-5.98 -4.3,-10.36 v -53.08 h 7.08 v 53.08 c 0,2.49 0.84,4.47 2.53,5.91 1.68,1.45 4.25,2.17 7.68,2.17 3.37,0 5.88,-0.72 7.53,-2.17 1.65,-1.45 2.48,-3.42 2.48,-5.91 z" class="st0" id="path1"></path><path d="m 240.76,365.89 h 7.08 v 5.56 c 0,4.38 -1.35,7.84 -4.04,10.36 -2.7,2.53 -6.88,3.79 -12.54,3.79 -5.66,0 -9.88,-1.26 -12.64,-3.79 -2.76,-2.53 -4.14,-5.98 -4.14,-10.36 v -40.44 c 0,-4.38 1.35,-7.84 4.04,-10.36 2.7,-2.53 6.88,-3.79 12.54,-3.79 5.66,0 9.87,1.26 12.64,3.79 2.76,2.53 4.14,5.98 4.14,10.36 v 9.61 h -7.08 v -9.61 c 0,-2.56 -0.79,-4.55 -2.38,-5.96 -1.59,-1.42 -4.03,-2.12 -7.33,-2.12 -3.23,0 -5.63,0.71 -7.18,2.12 -1.55,1.42 -2.33,3.4 -2.33,5.96 v 40.44 c 0,2.49 0.79,4.47 2.38,5.91 1.58,1.45 4.03,2.17 7.33,2.17 3.23,0 5.63,-0.72 7.18,-2.17 1.55,-1.45 2.32,-3.42 2.32,-5.91 v -5.56 z" class="st0" id="path2"></path><path d="m 265.53,384.09 v -65.72 h 7.08 v 29.32 h 19.92 v -29.32 h 7.08 v 65.72 h -7.08 V 353.76 H 272.6 v 30.33 z" class="st0" id="path3"></path><path d="m 319.82,384.09 v -65.72 h 28.81 v 6.07 H 326.9 v 23.25 h 17.69 v 6.07 H 326.9 v 24.27 h 22.75 v 6.07 h -29.83 z" class="st0" id="path4"></path><path d="m 364.81,384.09 v -65.72 h 6.77 l 22.24,50.55 v -50.55 h 7.08 v 65.72 h -6.77 l -22.24,-50.55 v 50.55 z" class="st0" id="path5"></path><path d="m 419.61,384.09 v -11.12 h 9.1 v 11.12 z" class="st0" id="path6"></path><path d="m 447.41,384.09 v -65.72 h 9.91 l 12.34,44.39 12.23,-44.39 h 9.91 v 65.72 h -7.08 V 329.7 l -11.83,42.26 h -6.57 L 454.49,329.7 v 54.39 z" class="st0" id="path7"></path><path d="m 512.02,318.37 h 7.08 v 59.65 h 18.5 v 6.07 h -25.58 z" class="st0" id="path8"></path></g></g></g><g id="g15" transform="translate(-271.20994,-114.40412)"><path d="m 428.74,204.77 c 0,13.54 -0.06,27.08 0.05,40.62 0.02,3.09 -0.97,5.01 -3.76,6.61 -23.48,13.42 -46.92,26.92 -70.25,40.6 -3.58,2.1 -6.24,1.93 -9.72,-0.11 -23.14,-13.55 -46.38,-26.94 -69.66,-40.25 -2.95,-1.69 -4.2,-3.62 -4.19,-7.06 0.11,-27.19 0.11,-54.39 0.01,-81.58 -0.01,-3.36 1.03,-5.43 4.04,-7.14 23.59,-13.47 47.1,-27.06 70.57,-40.73 2.92,-1.7 5.25,-1.81 8.23,-0.07 23.56,13.74 47.18,27.38 70.86,40.92 2.9,1.66 3.9,3.67 3.87,6.9 -0.13,13.75 -0.05,27.52 -0.05,41.29 z m -146.95,-0.61 c 0,11.82 0.07,23.63 -0.05,35.45 -0.03,2.85 0.86,4.64 3.4,6.09 20.29,11.61 40.53,23.29 60.71,35.08 2.94,1.72 5.26,1.77 8.22,0.04 20.18,-11.8 40.42,-23.48 60.71,-35.09 2.51,-1.44 3.49,-3.16 3.48,-6.04 -0.09,-23.63 -0.09,-47.26 0.01,-70.89 0.01,-2.95 -1.13,-4.56 -3.59,-5.97 -20.48,-11.73 -40.91,-23.54 -61.31,-35.41 -2.36,-1.37 -4.28,-1.44 -6.66,-0.05 -20.5,11.93 -41.03,23.79 -61.61,35.59 -2.37,1.36 -3.39,2.98 -3.36,5.75 0.12,11.82 0.05,23.63 0.05,35.45 z" class="st0" id="path9"></path><path d="m 328.36,147.58 c 6.72,-3.83 13.42,-7.7 20.17,-11.46 0.66,-0.37 1.85,-0.46 2.49,-0.12 6.92,3.79 13.77,7.68 20.65,11.55 -0.17,0.42 -0.33,0.83 -0.5,1.25 -14.11,0 -28.23,0 -42.34,0 -0.16,-0.4 -0.32,-0.81 -0.47,-1.22 z" class="st1" id="path10"></path><path d="m 290.11,194.66 c 0.04,-7.73 0.04,-15.47 0.16,-23.2 0.01,-0.76 0.52,-1.84 1.14,-2.21 6.74,-4.1 13.54,-8.09 20.33,-12.1 0.28,0.35 0.55,0.7 0.83,1.05 -7.06,12.22 -14.11,24.45 -21.17,36.67 -0.43,-0.07 -0.86,-0.14 -1.29,-0.21 z" class="st2" id="path11"></path><path d="m 311.76,251.31 c -6.68,-3.9 -13.37,-7.77 -20.01,-11.74 -0.65,-0.39 -1.33,-1.37 -1.35,-2.1 -0.18,-7.88 -0.23,-15.77 -0.32,-23.66 0.44,-0.06 0.89,-0.13 1.33,-0.19 7.06,12.22 14.11,24.45 21.17,36.67 -0.27,0.35 -0.55,0.69 -0.82,1.02 z" class="st1" id="path12"></path><path d="m 371.64,260.9 c -6.72,3.83 -13.42,7.7 -20.17,11.46 -0.66,0.37 -1.85,0.46 -2.49,0.12 -6.92,-3.79 -13.77,-7.68 -20.65,-11.55 0.17,-0.42 0.33,-0.83 0.5,-1.25 14.11,0 28.23,0 42.34,0 0.16,0.4 0.32,0.81 0.47,1.22 z" class="st2" id="path13"></path><path d="m 409.89,213.83 c -0.04,7.73 -0.04,15.47 -0.16,23.2 -0.01,0.76 -0.52,1.84 -1.14,2.21 -6.74,4.1 -13.54,8.09 -20.33,12.1 -0.28,-0.35 -0.55,-0.7 -0.83,-1.05 7.06,-12.22 14.11,-24.45 21.17,-36.67 0.43,0.07 0.86,0.14 1.29,0.21 z" class="st1" id="path14"></path><path d="m 388.24,157.17 c 6.68,3.9 13.37,7.77 20.01,11.74 0.65,0.39 1.33,1.37 1.35,2.1 0.18,7.88 0.23,15.77 0.32,23.66 -0.44,0.06 -0.89,0.13 -1.33,0.19 -7.06,-12.22 -14.11,-24.45 -21.17,-36.67 0.27,-0.34 0.55,-0.68 0.82,-1.02 z" class="st2" id="path15"></path></g></svg></span></a><div class="hidden backdrop-blur-xl backdrop-filter bg-box-bg bg-opacity-50 fixed inset-0 lg:!hidden" aria-hidden="true" data-nav-overlay></div><div class="flex flex-col lg:flex-row lg:items-center w-full absolute bg-body border-x border-x-box-border duration-300 ease-linear gap-x-4 gap-y-6 h-0 lg:!h-auto lg:bg-transparent lg:border-x-0 lg:justify-between lg:relative lg:scale-y-100 lg:top-0 overflow-hidden top-full" data-navbar><ul class="flex flex-col lg:flex-row lg:items-center w-full border-box-border border-t gap-x-3 gap-y-4 lg:border-t-0 lg:justify-center lg:pt-0 lg:px-0 pt-6 px-6 text-heading-2 text-lg"><li><a href="/" class="duration-300 ease-linear font-medium hover:text-primary py-3">Home</a></li><li><a href="/blog" class="duration-300 ease-linear font-medium hover:text-primary py-3">Blog</a></li></ul></div><div class="flex gap-x-3 items-center min-w-max"><button class="flex relative outline-none border border-box-border lg:p-3 p-2 rounded-full text-heading-2" data-switch-theme><svg class="w-6 h-6 dark:flex hidden" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" stroke-linecap="round" stroke-linejoin="round"></path></svg> <svg class="w-6 h-6 dark:hidden" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" stroke-linecap="round" stroke-linejoin="round"></path></svg> <span class="sr-only">switch theme</span></button> <button class="flex flex-col h-auto lg:hidden lg:invisible outline-none relative w-7" data-open-nav="false" data-toggle-nav><span class="w-6 bg-heading-2 duration-300 ease-linear h-0.5 transition-all rounded-full" id="line1"></span> <span class="w-6 bg-heading-2 duration-300 ease-linear h-0.5 transition-all mt-1 rounded-ful origin-center" id="line2"></span> <span class="w-6 bg-heading-2 duration-300 ease-linear h-0.5 transition-all mt-1 rounded-ful" id="line3"></span> <span class="sr-only">togglenav</span></button> <a href="/rss.xml" class="dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hidden hover:bg-gray-100 items-center md:inline-flex p-2.5 rounded-lg text-muted text-sm" aria-label="RSS Feed"><svg class="h-5 w-5" height="1em" width="1em" data-icon="tabler:rss"><symbol id="ai:tabler:rss" viewBox="0 0 24 24"><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke="currentColor" stroke-width="2"/></symbol><use href="#ai:tabler:rss"></use></svg></a></div></nav></div></header><main class="flex flex-col overflow-hidden pt-24"><section class="mx-auto lg:py-20 px-2 py-8 sm:py-16"><article><header class><div class="flex flex-col justify-between max-w-3xl sm:flex-row mb-2 mt-0 sm:items-center"><p><svg class="inline-block -mt-0.5 dark:text-gray-400 h-4 w-4" height="1em" width="1em" data-icon="tabler:clock"><symbol id="ai:tabler:clock" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0-18 0"/><path d="M12 7v5l3 3"/></g></symbol><use href="#ai:tabler:clock"></use></svg> <time class="inline-block dark:text-slate-400" datetime="Fri Apr 19 2024 17:00:00 GMT-0700 (Pacific Daylight Time)">Apr 20, 2024</time> · <svg class="inline-block -mt-0.5 dark:text-gray-400 h-4 w-4" height="1em" width="1em" data-icon="tabler:user"><symbol id="ai:tabler:user" viewBox="0 0 24 24"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0-8 0M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke="currentColor" stroke-width="2"/></symbol><use href="#ai:tabler:user"></use></svg> <span class="inline-block dark:text-slate-400">Eugene Ostroukhov </span>· <a href="/category/case-studies" class="inline-block dark:text-slate-400 hover:underline">Case Studies </a>&nbsp;· <span>7</span> min read</p></div><h1 class="max-w-3xl dark:text-slate-200 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Case Study - Optimizing Linear Layer</h1><p class="max-w-3xl dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl">This case study details the process of optimizing linear layer performance without breaking the core Uchen.ML requirements.</p><div class="max-w-3xl mx-auto"><div class="border-t dark:border-slate-700"></div></div></header><div class="max-w-3xl mx-auto mt-8 dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:scroll-mt-[80px] prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-li:my-0 prose-md prose-slate"><h2 id="overview">Overview</h2><p>As Uchen.ML is heading towards the public announcement and first demos, some low-hanging fruit needs to be picked in terms of optimizations. The most often used piece of any ML library is the linear layer as it is the most basic building block for any neural net. This post details the process of optimizing the code.</p><h2 id="requirements">Requirements</h2><p>Uchen.ML is designed for implementing ML solutions that can be easily integrated into existing systems, with specific goals on Web Assembly, embedded and video games.</p><p>To maintain velocity and to avoid overcomplicating build and validation process, following constraints are in place:</p><ul><li>Only the C++20 standard library is used. ABSL dependency is there (logging, asserts and some utilities) but it is under consideration if its inclusion will remain mandatory.</li><li>No compiler-specific optimizations, including pragmas, conditional compilations or intrinsics.</li><li>No CPU architecture-specific optimizations. Particularly, no optimizations for one architecture that may be detrimental for others. Apple M2 and Intel Core CPUs are used to inform and direct the optimization efforts.</li><li>Uchen.ML is and will remain a CPU-only ML framework. There are no plans at this point to implement GPU or other acceleration support.</li></ul><p>This constraints will be lifted as the deployment targets and actual requirements are better understood.</p><h2 id="benchmark-code">Benchmark code</h2><p>The benchmark runs inference through the linear layers of different configurations. Inputs are initialized to 0, parameters are initialized to random values outside the benchmark loop. Range of parameter values is between -1 and 1. Output values are not checked. float datatype is used for inputs and outputs</p><pre class="astro-code github-dark" data-language="c" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#e1e4e8">template </span><span style="color:#f97583">&#x3C;size_t</span><span style="color:#e1e4e8"> Is, </span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> Os, typename D </span><span style="color:#f97583">=</span><span style="color:#f97583"> float></span></span>
<span class="line"><span style="color:#f97583">static</span><span style="color:#f97583"> void</span><span style="color:#b392f0"> BM_Linear</span><span style="color:#e1e4e8">(benchmark::State</span><span style="color:#f97583">&#x26;</span><span style="color:#ffab70"> state</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#6a737d">  // Linear layer with Is inputs and Os outputs</span></span>
<span class="line"><span style="color:#e1e4e8">  uchen::Linear</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">uchen::Vector</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">D, Is</span><span style="color:#f97583">></span><span style="color:#e1e4e8">, Os</span><span style="color:#f97583">></span><span style="color:#e1e4e8"> layer;</span></span>
<span class="line"><span style="color:#6a737d">  // zero-initialized input vector. This operation is O(n) to the number</span></span>
<span class="line"><span style="color:#6a737d">  // of the inputs and may have a negligible impact on benchmark.</span></span>
<span class="line"><span style="color:#e1e4e8">  uchen::Vector</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">D, Is</span><span style="color:#f97583">></span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#6a737d">  // Parameters are using the store filled with random values outside</span></span>
<span class="line"><span style="color:#6a737d">  // the loop This operation is O(1) to the number of parameters and has</span></span>
<span class="line"><span style="color:#6a737d">  // no impact on benchmark.</span></span>
<span class="line"><span style="color:#e1e4e8">  uchen::</span><span style="color:#79b8ff">parameters_t</span><span style="color:#f97583">&#x3C;</span><span style="color:#b392f0">decltype</span><span style="color:#e1e4e8">(layer)</span><span style="color:#f97583">></span><span style="color:#b392f0"> parameters</span><span style="color:#e1e4e8">(params-></span><span style="color:#b392f0">store</span><span style="color:#e1e4e8">());</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (auto _ : state) {</span></span>
<span class="line"><span style="color:#b392f0">    benchmark::DoNotOptimize</span><span style="color:#e1e4e8">(</span><span style="color:#b392f0">layer</span><span style="color:#e1e4e8">(input, parameters));</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><h2 id="hardware">Hardware</h2><p>Regular PCs are used. Note that the numbers can not be compared across the architectures and this paper is only concerned with the relative gains and not the absolute values.</p><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span>Apple M2 Pro</span></span>
<span class="line"><span>  10 Cores</span></span>
<span class="line"><span>  L1 Data 64 KiB</span></span>
<span class="line"><span>  L1 Instruction 128 KiB</span></span>
<span class="line"><span>  L2 Unified 4096 KiB (x10)</span></span></code></pre><pre class="astro-code github-dark" data-language="plaintext" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span>Intel(R) Core(TM) i7-10700KF CPU @ 3.80GHz   3.79 GHz</span></span>
<span class="line"><span>  L1 Data 32 KiB (x8)</span></span>
<span class="line"><span>  L1 Instruction 32 KiB (x8)</span></span>
<span class="line"><span>  L2 Unified 256 KiB (x8)</span></span>
<span class="line"><span>  L3 Unified 16384 KiB (x1)</span></span></code></pre><h2 id="naive-version">Naive version</h2><p>Linear layer runs the following operation to produce the output: <math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>=</mo><msub><mi>b</mi><mi>j</mi></msub><mo>+</mo><mrow><munderover><mo movablelimits="false">∑</mo><mrow><mi>i</mi><mo>= 0</mo></mrow><mi>n</mi></munderover></mrow><msub><mi>w</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub><msub><mi>x</mi><mi>i</mi></msub></mrow></math></p><p>Which translated into the following C++ code:</p><pre class="astro-code github-dark" data-language="c" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#79b8ff">output_t</span><span style="color:#b392f0"> operator</span><span style="color:#e1e4e8">()(</span><span style="color:#f97583">const</span><span style="color:#79b8ff"> input_t</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8"> inputs,</span></span>
<span class="line"><span style="color:#f97583">                    const</span><span style="color:#e1e4e8"> Parameters</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">parameter_count</span><span style="color:#f97583">>&#x26;</span><span style="color:#e1e4e8"> parameters) </span><span style="color:#f97583">const</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#79b8ff">  output_t</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#e1e4e8">  constexpr </span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> Is </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> input_t</span><span style="color:#e1e4e8">::elements;</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> output </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; output </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> Outputs; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">output) {</span></span>
<span class="line"><span style="color:#ffab70">    outputs</span><span style="color:#e1e4e8">[output] </span><span style="color:#f97583">=</span><span style="color:#ffab70"> parameters</span><span style="color:#e1e4e8">[output </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> (Is </span><span style="color:#f97583">+</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> Is];</span></span>
<span class="line"><span style="color:#f97583">    for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> input </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; input </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> Is; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">input) {</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[output] </span><span style="color:#f97583">+=</span></span>
<span class="line"><span style="color:#ffab70">          inputs</span><span style="color:#e1e4e8">[input] </span><span style="color:#f97583">*</span><span style="color:#ffab70"> parameters</span><span style="color:#e1e4e8">[output </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> (Is </span><span style="color:#f97583">+</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> input];</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  return</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><p>Given <em>n</em> inputs and <em>m</em> outputs, parameters layout is: Parameters are a flat array in the following format (n is a number of inputs, m is the number of outputs): <math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mo form="prefix" stretchy="false">{</mo><msub><mi>w</mi><mrow><mn>00</mn></mrow></msub><mo separator="true">, … ,</mo><msub><mi>w</mi><mrow><mn>0</mn><mi>n</mi></mrow></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mn>1</mn><mn>0</mn></mrow></msub><mo separator="true">, … ,</mo><msub><mi>w</mi><mrow><mi>m</mi><mi>n</mi></mrow></msub><mo separator="true">,</mo><msub><mi>b</mi><mi>m</mi></msub><mo form="postfix" stretchy="false">}</mo></mrow></math></p><h3 id="benchmark-results">Benchmark Results:</h3><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">Parameter Count</th><th align="center">i7-10700KF</th><th align="center">Apple M2 Pro</th></tr></thead><tbody><tr><td align="center">&#x3C;100, 200></td><td align="center">20,200</td><td align="center">13,645 ns</td><td align="center">6882 ns</td></tr><tr><td align="center">&#x3C;2500, 8></td><td align="center">20,008</td><td align="center">17,086 ns</td><td align="center">16,307 ns</td></tr><tr><td align="center">&#x3C;8, 2500></td><td align="center">22,500</td><td align="center">5032 ns</td><td align="center">2177 ns</td></tr></tbody></table></div><p>Note that the number of operations (memory reads, stores and arithmetic) is directly correlated to the number of parameters so all the models were set up to have roughly the same number of them.</p><p>Intel architecture shows approximately 3.4x spread between the best case scenario (number outputs drastically exceeds number of inputs) and worst case scenario (number of inputs is much greater then the number of outputs). Apple ARM implementation showed 7.5x spread.</p><h1 id="transposed-iteration-order">Transposed iteration order</h1><p>The first optimization is to change the iteration order. Instead of iterating over the outputs and then over the inputs, we iterate over the inputs and then over the outputs. This change allows for better cache utilization and reduces the number of cache misses.</p><pre class="astro-code github-dark" data-language="c" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#79b8ff">output_t</span><span style="color:#b392f0"> operator</span><span style="color:#e1e4e8">()(</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#79b8ff"> input_t</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8"> inputs,</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#e1e4e8"> Parameters</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">(Input::elements </span><span style="color:#f97583">+</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> Outputs</span><span style="color:#f97583">>&#x26;</span><span style="color:#e1e4e8"> parameters) </span><span style="color:#f97583">const</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">  auto it </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parameters.</span><span style="color:#b392f0">begin</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#79b8ff">  output_t</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> outputs.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">(); i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#ffab70">    outputs</span><span style="color:#e1e4e8">[i] </span><span style="color:#f97583">=</span><span style="color:#f97583"> *</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (auto input : inputs) {</span></span>
<span class="line"><span style="color:#f97583">    for</span><span style="color:#e1e4e8"> (auto</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8"> output : outputs) {</span></span>
<span class="line"><span style="color:#e1e4e8">      output </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  return</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><p>Note that the code uses a linear iteration over the parameters, making the memory access pattern more predictable and cache-friendly.</p><p>Parameters layout is as follows (n is a number of inputs, m is the number of outputs): <math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mo form="prefix" stretchy="false">{</mo><msub><mi>b</mi><mn>0</mn></msub><mo separator="true">, … ,</mo><msub><mi>b</mi><mn>m</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mn>0</mn><mn>0</mn></mrow></msub><mo separator="true">, … ,</mo><msub><mi>w</mi><mrow><mn>0</mn><mi>n</mi></mrow></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mn>1</mn><mn>0</mn></mrow></msub><mo separator="true">, … ,</mo><msub><mi>w</mi><mrow><mi>m</mi><mn>0</mn></mrow></msub><mo form="postfix" stretchy="false">}</mo></mrow></math></p><h3 id="benchmark-results-1">Benchmark Results:</h3><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">i7-10700KF</th><th align="center">Apple M2 Pro</th></tr></thead><tbody><tr><td align="center">100, 200</td><td align="center">1880 ns</td><td align="center">1326 ns</td></tr><tr><td align="center">2500, 8</td><td align="center">5611ns</td><td align="center">11,124 ns</td></tr><tr><td align="center">8, 2500</td><td align="center">2015 ns</td><td align="center">1354 ns</td></tr></tbody></table></div><p>Number of inputs has a significant negative impact on the performance as it adds an extra memory load.</p><h2 id="compile-for-the-specific-cpu">Compile for the specific CPU</h2><p>By default, the compiler generates the code that works on most CPUs. This precludes usage of some newer instructions that have a significant impact on the performance. To test this, I pass <code>-march=native</code> to the compiler which makes it target my current CPU. I am using Bazel, so the invocation looked like this (<code>-g</code> is for including debugging symbols as I use <code>gdb</code> to look at the assembly code):</p><pre class="astro-code github-dark" data-language="bash" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#b392f0">bazel</span><span style="color:#9ecbff"> run</span><span style="color:#79b8ff"> -c</span><span style="color:#9ecbff"> opt</span><span style="color:#79b8ff"> --cxxopt=</span><span style="color:#9ecbff">"-g"</span><span style="color:#79b8ff"> --cxxopt=</span><span style="color:#9ecbff">"-march=native"</span><span style="color:#9ecbff"> //benchmark:linear</span></span></code></pre><h3 id="benchmark-results-intel-only">Benchmark Results (Intel only):</h3><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">i7-10700KF</th></tr></thead><tbody><tr><td align="center">100, 200</td><td align="center">1203 ns</td></tr><tr><td align="center">2500, 8</td><td align="center">4871 ns</td></tr><tr><td align="center">8, 2500</td><td align="center">1080 ns</td></tr></tbody></table></div><p>This “optimization” shows pretty solid across the board. Ultimately, it will be up to embedders to decide the CPU target to compile for.</p><h2 id="a-bigger-layer">A bigger layer</h2><p>With the numbers in single digit microseconds, it seems reasonable to increase the size of the linear layer to see what impact it has on the performance.</p><h3 id="benchmark-results-intel-only-1">Benchmark Results (Intel only):</h3><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">i7-10700KF</th></tr></thead><tbody><tr><td align="center">100, 200</td><td align="center">1180 ns</td></tr><tr><td align="center">2500, 8</td><td align="center">5056 ns</td></tr><tr><td align="center">8, 2500</td><td align="center">1148 ns</td></tr><tr><td align="center">4000, 2000</td><td align="center">1496652 ns</td></tr><tr><td align="center">1000000, 8</td><td align="center">2986400 ns</td></tr><tr><td align="center">8, 1000000</td><td align="center">2185253 ns</td></tr></tbody></table></div><p>The worst case is “only” 2x slower than the best case.</p><h2 id="using-simd-intrinsics-directly">Using SIMD intrinsics directly</h2><p>As mentioned above, SIMD intrinsics are not considered (i.e. Web Assembly still has no support for them). However, it is still interesting to see what the performance gains could be if we tried them. I did not use AVX as data alignment is not supported yet, though this will change soon.</p><pre class="astro-code github-dark" data-language="c" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#79b8ff">output_t</span><span style="color:#b392f0"> operator</span><span style="color:#e1e4e8">()(</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#79b8ff"> input_t</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8"> inputs,</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#e1e4e8"> Parameters</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">(Input::elements </span><span style="color:#f97583">+</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> Outputs</span><span style="color:#f97583">>&#x26;</span><span style="color:#e1e4e8"> parameters) </span><span style="color:#f97583">const</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">  auto it </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parameters.</span><span style="color:#b392f0">begin</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#79b8ff">  output_t</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> outputs.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">(); i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#ffab70">    outputs</span><span style="color:#e1e4e8">[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> Input::elements; i </span><span style="color:#f97583">+=</span><span style="color:#79b8ff"> 4</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#e1e4e8">    __m128 input </span><span style="color:#f97583">=</span><span style="color:#b392f0"> _mm_loadu_ps</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">inputs.</span><span style="color:#b392f0">begin</span><span style="color:#e1e4e8">()) </span><span style="color:#f97583">+</span><span style="color:#e1e4e8"> i);</span></span>
<span class="line"><span style="color:#f97583">    for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> j </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; j </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> Outputs; </span><span style="color:#f97583">++</span><span style="color:#e1e4e8">j) {</span></span>
<span class="line"><span style="color:#6a737d">      // Parameters are accessed in the wrong order - this is a bug!</span></span>
<span class="line"><span style="color:#6a737d">      // This code is for benchmark only.</span></span>
<span class="line"><span style="color:#e1e4e8">      __m128 parameters </span><span style="color:#f97583">=</span><span style="color:#b392f0"> _mm_load_ps</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8">(</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it));</span></span>
<span class="line"><span style="color:#e1e4e8">      __m128 product </span><span style="color:#f97583">=</span><span style="color:#b392f0"> _mm_dp_ps</span><span style="color:#e1e4e8">(input, parameters, </span><span style="color:#f97583">0x</span><span style="color:#79b8ff">f1</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">      it </span><span style="color:#f97583">+=</span><span style="color:#79b8ff"> 4</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[j] </span><span style="color:#f97583">+=</span><span style="color:#b392f0"> _mm_cvtss_f32</span><span style="color:#e1e4e8">(product);</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  return</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#e1e4e8">};</span></span></code></pre><h3 id="benchmark-results-intel-only-2">Benchmark Results (Intel only):</h3><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">i7-10700KF</th></tr></thead><tbody><tr><td align="center">100, 200</td><td align="center">5765 ns</td></tr><tr><td align="center">2500, 8</td><td align="center">5955 ns</td></tr><tr><td align="center">8, 2500</td><td align="center">5761 ns</td></tr><tr><td align="center">4000, 2000</td><td align="center">2783286 ns</td></tr><tr><td align="center">1000000, 8</td><td align="center">2964343 ns</td></tr><tr><td align="center">8, 1000000</td><td align="center">3214760 ns</td></tr></tbody></table></div><p>“Good” cases worsened, which shows that the updated code is ran. Shape of the data is known at compile time when using Uchen.ML so the compilers make informed decisions about vectorization and other optimizations and it looks like competing with them is an unnecessary exercise.</p><p>Manually unrolling the loop yields similar results:</p><pre class="astro-code github-dark" data-language="c" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#79b8ff">output_t</span><span style="color:#b392f0"> operator</span><span style="color:#e1e4e8">()(</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#79b8ff"> input_t</span><span style="color:#f97583">&#x26;</span><span style="color:#e1e4e8"> inputs,</span></span>
<span class="line"><span style="color:#f97583">    const</span><span style="color:#e1e4e8"> Parameters</span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8">(Input::elements </span><span style="color:#f97583">+</span><span style="color:#79b8ff"> 1</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> Outputs</span><span style="color:#f97583">>&#x26;</span><span style="color:#e1e4e8"> parameters) </span><span style="color:#f97583">const</span><span style="color:#e1e4e8"> {</span></span>
<span class="line"><span style="color:#e1e4e8">  auto it </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> parameters.</span><span style="color:#b392f0">begin</span><span style="color:#e1e4e8">();</span></span>
<span class="line"><span style="color:#79b8ff">  output_t</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> outputs.</span><span style="color:#b392f0">size</span><span style="color:#e1e4e8">(); i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#ffab70">    outputs</span><span style="color:#e1e4e8">[i] </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  for</span><span style="color:#e1e4e8"> (auto input : inputs) {</span></span>
<span class="line"><span style="color:#f97583">    for</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">size_t</span><span style="color:#e1e4e8"> i </span><span style="color:#f97583">=</span><span style="color:#79b8ff"> 0</span><span style="color:#e1e4e8">; i </span><span style="color:#f97583">&#x3C;</span><span style="color:#e1e4e8"> Outputs; i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[i</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">] </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#ffab70">      outputs</span><span style="color:#e1e4e8">[i] </span><span style="color:#f97583">+=</span><span style="color:#e1e4e8"> (</span><span style="color:#f97583">*</span><span style="color:#e1e4e8">it</span><span style="color:#f97583">++</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">*</span><span style="color:#e1e4e8"> input;</span></span>
<span class="line"><span style="color:#e1e4e8">    }</span></span>
<span class="line"><span style="color:#e1e4e8">  }</span></span>
<span class="line"><span style="color:#f97583">  return</span><span style="color:#e1e4e8"> outputs;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span></code></pre><div style="overflow:auto"><table><thead><tr><th align="center">&#x3C;inputs, outputs></th><th align="center">i7-10700KF</th></tr></thead><tbody><tr><td align="center">100, 200</td><td align="center">6523 ns</td></tr><tr><td align="center">2500, 8</td><td align="center">5088 ns</td></tr><tr><td align="center">8, 2500</td><td align="center">6763 ns</td></tr><tr><td align="center">4000, 2000</td><td align="center">3226969 ns</td></tr><tr><td align="center">1000000, 8</td><td align="center">2918274 ns</td></tr><tr><td align="center">8, 1000000</td><td align="center">3734533 ns</td></tr></tbody></table></div><h2 id="conclusion">Conclusion</h2><p>At this point it looks like the performance on this granularity is pretty close to the practical limit for <em>a single core</em>. Next article will detail multi-threading and the memory alignment (particularly, dealing with the number of parameters not divisible by 8).</p><p>The backpropagation optimizations and Uchen’s approach to the memory management will also be detailed in the future articles.</p></div><div class="flex flex-col justify-between max-w-3xl sm:flex-row mt-8 mx-auto"><ul class="rtl:mr-0 mr-5 rtl:ml-5"><li class="inline-block bg-gray-50 border border-1 border-slate-300 dark:bg-slate-700 lowercase mb-2 mr-2 px-2 py-0.5 rounded-sm rtl:ml-2 rtl:mr-0"><a href="/tag/c" class="hover:text-primary dark:hover:text-gray-200 dark:text-slate-100 text-muted">c++</a></li><li class="inline-block bg-gray-50 border border-1 border-slate-300 dark:bg-slate-700 lowercase mb-2 mr-2 px-2 py-0.5 rounded-sm rtl:ml-2 rtl:mr-0"><a href="/tag/uchen-ml" class="hover:text-primary dark:hover:text-gray-200 dark:text-slate-100 text-muted">uchen.ml</a></li><li class="inline-block bg-gray-50 border border-1 border-slate-300 dark:bg-slate-700 lowercase mb-2 mr-2 px-2 py-0.5 rounded-sm rtl:ml-2 rtl:mr-0"><a href="/tag/testing" class="hover:text-primary dark:hover:text-gray-200 dark:text-slate-100 text-muted">testing</a></li><li class="inline-block bg-gray-50 border border-1 border-slate-300 dark:bg-slate-700 lowercase mb-2 mr-2 px-2 py-0.5 rounded-sm rtl:ml-2 rtl:mr-0"><a href="/tag/case-study" class="hover:text-primary dark:hover:text-gray-200 dark:text-slate-100 text-muted">case study</a></li></ul><div class="align-middle dark:text-slate-600 mt-5 sm:mt-1 text-gray-500"><span class="dark:text-slate-400 align-super font-bold text-slate-500">Share:</span> <button class="ml-2 rtl:ml-0 rtl:mr-2" data-aw-social-share="twitter" data-aw-url="https://uchenml.tech/optimizing-linear" title="Twitter Share" data-aw-text="Case Study - Optimizing Linear Layer"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" height="1em" width="1em" data-icon="tabler:brand-x"><symbol id="ai:tabler:brand-x" viewBox="0 0 24 24"><path d="m4 4l11.733 16H20L8.267 4zm0 16l6.768-6.768m2.46-2.46L20 4" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke="currentColor" stroke-width="2"/></symbol><use href="#ai:tabler:brand-x"></use></svg></button> <button class="ml-2 rtl:ml-0 rtl:mr-2" data-aw-social-share="facebook" data-aw-url="https://uchenml.tech/optimizing-linear" title="Facebook Share"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" height="1em" width="1em" data-icon="tabler:brand-facebook"><symbol id="ai:tabler:brand-facebook" viewBox="0 0 24 24"><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 0 1 1-1h3V3h-3a5 5 0 0 0-5 5v2z" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke="currentColor" stroke-width="2"/></symbol><use href="#ai:tabler:brand-facebook"></use></svg></button> <button class="ml-2 rtl:ml-0 rtl:mr-2" data-aw-social-share="linkedin" data-aw-url="https://uchenml.tech/optimizing-linear" title="Linkedin Share" data-aw-text="Case Study - Optimizing Linear Layer"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" height="1em" width="1em" data-icon="tabler:brand-linkedin"><symbol id="ai:tabler:brand-linkedin" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M8 11v5m0-8v.01M12 16v-5m4 5v-3a2 2 0 1 0-4 0"/><path d="M3 7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4z"/></g></symbol><use href="#ai:tabler:brand-linkedin"></use></svg></button> <button class="ml-2 rtl:ml-0 rtl:mr-2" data-aw-social-share="mail" data-aw-url="https://uchenml.tech/optimizing-linear" title="Email Share" data-aw-text="Case Study - Optimizing Linear Layer"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" height="1em" width="1em" data-icon="tabler:mail"><symbol id="ai:tabler:mail" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="m3 7l9 6l9-6"/></g></symbol><use href="#ai:tabler:mail"></use></svg></button></div></div></article></section><div class="max-w-3xl mx-auto md:pt-4 pt-8 px-6 sm:px-6"><a href="/blog" class="flex btn btn-tertiary dark:text-slate-400 md:px-3 px-3"><svg class="h-5 w-5 -ml-1.5 mr-1 rtl:-mr-1.5 rtl:ml-1" height="1em" width="1em" data-icon="tabler:chevron-left"><symbol id="ai:tabler:chevron-left" viewBox="0 0 24 24"><path d="m15 6l-6 6l6 6" stroke-linecap="round" stroke-linejoin="round" fill="none" stroke="currentColor" stroke-width="2"/></symbol><use href="#ai:tabler:chevron-left"></use></svg> Back to Blog</a></div></main><footer class="border-t bg-amber-100 bg-gradient-to-tr dark:bg-slate-800 mt-20"><div class="mx-auto lg:px-5 max-w-7xl md:px-14 px-5 sm:px-8 w-full overflow-auto pb-8 relative"><div class="flex items-center gap-4 min-h-max mt-8 text-heading-3"><div class="h-auto flex-grow md:text-lg self-stretch text-heading-3">&copy; <span id="year">2024</span> Eugene Ostroukhov. All right reserved</div><a href="https://www.linkedin.com/in/eostroukhov/" class="hover:scale-105 hover:text-heading-1 transition"><svg class="h-5 w-5" height="16" width="16" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"></path></svg> <span class="sr-only">social link</span> </a><a href="https://twitter.com/eeuoss" class="hover:scale-105 hover:text-heading-1 transition"><svg class="h-5 w-5" height="16" width="16" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"></path></svg> <span class="sr-only">social link</span> </a><a href="https://github.com/eugeneo" class="hover:scale-105 hover:text-heading-1 transition"><svg class="h-5 w-5" height="16" width="16" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg> <span class="sr-only">social link</span></a></div></div></footer><script>!function(){const e="system";if(window.basic_script)return;function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}window.basic_script=!0;const d=function(){e&&e.endsWith(":only")||(localStorage.theme,0)?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light")};function a(e,t,d){const a="string"==typeof e?document.querySelectorAll(e):e;a&&a.length&&a.forEach((e=>{e.addEventListener(t,(t=>d(t,e)),!1)}))}d();const o=function(){let t=window.scrollY,d=!0;a("#header nav","click",(function(){document.querySelector("[data-aw-toggle-menu]")?.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.getElementById("header")?.classList.remove("bg-page"),document.querySelector("#header nav")?.classList.add("hidden"),document.querySelector("#header > div > div:last-child")?.classList.add("hidden")})),a("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.getElementById("header")?.classList.toggle("expanded"),document.getElementById("header")?.classList.toggle("bg-page"),document.querySelector("#header nav")?.classList.toggle("hidden"),document.querySelector("#header > div > div:last-child")?.classList.toggle("hidden")})),a("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light")})),a("[data-aw-social-share]","click",(function(e,t){const d=t.getAttribute("data-aw-social-share"),a=encodeURIComponent(t.getAttribute("data-aw-url")),o=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(d){case"facebook":c=`https://www.facebook.com/sharer.php?u=${a}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${a}&text=${o}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${a}&title=${o}`;break;case"whatsapp":c=`https://wa.me/?text=${o}%20${a}`;break;case"mail":c=`https://mail.google.com/?subject=%22${o}%22&body=${o}%20${a}`;break;default:return}const n=document.createElement("a");n.target="_blank",n.href=c,n.click()}));function o(){const e=document.querySelector("#header[data-aw-sticky-header]");e&&(t>60&&!e.classList.contains("scroll")?e.classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&e.classList.remove("scroll"),d=!1)}window.matchMedia("(max-width: 767px)").addEventListener("change",(function(){document.querySelector("[data-aw-toggle-menu]")?.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.getElementById("header")?.classList.remove("bg-page"),document.querySelector("#header nav")?.classList.add("hidden"),document.querySelector("#header > div > div:last-child")?.classList.add("hidden")})),o(),a([document],"scroll",(function(){t=window.scrollY,d||(window.requestAnimationFrame((()=>{o()})),d=!0)}))},c=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.querySelector("#header nav")?.classList.add("hidden")};window.onload=o,window.onpageshow=c,document.addEventListener("astro:after-swap",(()=>{d(),o(),c()}))}()</script><script type="module">const e=document.querySelector("[data-toggle-nav]"),t=document.querySelector("[data-navbar]"),a=document.querySelector("[data-nav-overlay]");e&&(e.addEventListener("click",(s=>{s.preventDefault(),"false"===e.getAttribute("data-open-nav")?(e.setAttribute("data-open-nav","true"),a.setAttribute("data-is-visible","true"),document.body.classList.add("!overflow-y-hidden"),t.style.height=`${t.scrollHeight}px`):(e.setAttribute("data-open-nav","false"),a.setAttribute("data-is-visible","false"),document.body.classList.remove("!overflow-y-hidden"),t.style.height="0px")})),t.addEventListener("click",(()=>{e.setAttribute("data-open-nav","false"),a.setAttribute("data-is-visible","false"),document.body.classList.remove("!overflow-y-hidden"),t.style.height="0px"})),a.addEventListener("click",(()=>{e.setAttribute("data-open-nav","false"),a.setAttribute("data-is-visible","false"),document.body.classList.remove("!overflow-y-hidden"),t.style.height="0px"})))</script><script type="module">const t=document.querySelector("[data-switch-theme]");"dark"===localStorage.getItem("appTheme")||!("appTheme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),t&&t.addEventListener("click",(e=>{e.preventDefault();const t=document.documentElement;t&&(localStorage.getItem("appTheme")?"light"===localStorage.getItem("appTheme")?(t.classList.add("dark"),localStorage.setItem("appTheme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("appTheme","light")):t.classList.contains("dark")?(t.classList.remove("dark"),localStorage.setItem("appTheme","light")):(t.classList.add("dark"),localStorage.setItem("appTheme","dark")))}))</script></body></html>